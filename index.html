<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, shrink-to-fit=0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <title>Contributor Network</title>

    <meta name="author" content="Development Seed">
    <meta name="description" content="An interactive visualization of contributors and their connections to repositories">
    <meta name="theme-color" content="#cf3f02">
    <meta property="og:title" content="The Development Seed Contributor Network">
    <meta property="og:url" content="https://developmentseed.org/contributor-network/">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en_US">
    <meta property="og:image" content="https://developmentseed.org/contributor-network/site-image.jpg">
    <meta property="og:image:type" content="image/jpeg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="800">

    <link rel="shortcut icon" type="image/png" href="assets/img/favicon.png" />
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400;1,700&family=Roboto+Condensed:wght@400;700&family=Fira+Code:wght@300..700&display=swap" rel="stylesheet">

    <script src="assets/lib/d3.v7.js"></script>
    <script src="assets/lib/d3-delaunay.js"></script>
    <script src="assets/lib/d3-bboxCollide.min.js"></script>
</head>
<body>
    <div id="chart-wrapper">
        <div id="chart-introduction">
            <div id="chart-title">
                <h1>The Contributor Network of</h1>
                <h1><span id="title-repo-name" class="central-repo">...</span></h1>
                <p id="last-commit-date"></p>
            </div>
            <div id="chart-intro-text">
                <p id="chart-description">Explore the network of contributors and repositories.</p>
                <p>This visualization is based off of the excellent <a href="https://nbremer.github.io/ORCA/top-contributor-network/">Top Contributor Network</a> from <a href="https://github.com/nbremer">Nadieh Bremer</a>, and is licensed the same (MPL).</p>
            </div>
        </div>

        <div id="chart-filters">
            <div id="filter-header">
                <label for="org-select">Filter by Organization:</label>
                <select id="org-select">
                    <option value="">-- All Organizations --</option>
                </select>
                <p id="filter-stats"></p>
            </div>
        </div>

        <div id="chart-container">
            <div id="chart-zoom-controls" aria-label="Zoom controls">
                <button id="zoom-in" type="button" aria-label="Zoom in">+</button>
                <button id="zoom-out" type="button" aria-label="Zoom out">−</button>
                <button id="zoom-reset" type="button" aria-label="Reset zoom">
                    <svg class="zoom-reset-icon" viewBox="0 0 24 24" role="img" aria-hidden="true" focusable="false">
                        <circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="12" r="1.5" fill="currentColor"/>
                        <path d="M12 3v3M12 18v3M3 12h3M18 12h3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { createContributorNetworkVisual } from './js/chart.js';

        // ─── Load configuration ───────────────────────────────────
        // In production, config.json is generated by the build command from config.toml.
        // For local development, place a config.json in assets/data/ with at minimum:
        //   { "organization_name": "My Org", "contributor_padding": 20, "contributors": {} }
        const configResponse = await fetch('assets/data/config.json');
        if (!configResponse.ok) {
            document.getElementById("chart-container").innerHTML =
                '<p style="color: red; padding: 20px;">Error: Could not load config.json. Run the build command or create assets/data/config.json for local development.</p>';
            throw new Error('Failed to load config.json');
        }
        const config = await configResponse.json();

        const organizationName = config.organization_name || 'Development Seed';
        const contributor_padding = config.contributor_padding || 20;

        // Build contributor lookup maps from config
        const masterContributors = config.contributors || {};
        const displayNameToUsername = {};
        Object.entries(masterContributors).forEach(([username, displayName]) => {
            displayNameToUsername[displayName] = username;
        });

        // ─── Populate page from config ────────────────────────────
        document.getElementById("title-repo-name").textContent = organizationName;
        if (config.title) document.title = config.title;
        if (config.description) document.getElementById("chart-description").textContent = config.description;

        // ─── Set up sizing ────────────────────────────────────────
        const container = document.getElementById("chart-container");
        const wrapper = document.getElementById("chart-wrapper");

        function getChartDimensions() {
            let wrapperRect = wrapper.getBoundingClientRect();
            let availableWidth = wrapperRect.width - 40;
            if (availableWidth < 400) {
                availableWidth = Math.min(window.innerWidth - 40, 1400 - 40);
            }
            return Math.max(availableWidth, 600);
        }

        // ─── Initialize visualization ─────────────────────────────
        let size = getChartDimensions();
        container.style.height = size + 'px';

        const contributorNetworkVisual = createContributorNetworkVisual(
            container,
            contributor_padding,
            masterContributors,
            displayNameToUsername
        )
            .width(size)
            .height(size);

        // ─── Load CSV data and render ─────────────────────────────
        const promises = [
            d3.csv('assets/data/top_contributors.csv'),
            d3.csv('assets/data/repositories.csv'),
            d3.csv('assets/data/links.csv')
        ];

        document.fonts.ready.then(() => {
            Promise.all(promises).then(values => {
                // Generate organization filter options
                const uniqueOrgs = new Set();
                values[1].forEach(repo => {
                    const owner = repo.repo.substring(0, repo.repo.indexOf("/"));
                    if (owner) uniqueOrgs.add(owner);
                });

                const sortedOrgs = Array.from(uniqueOrgs).sort();
                const orgSelect = document.getElementById("org-select");
                sortedOrgs.forEach(org => {
                    const option = document.createElement("option");
                    option.value = org;
                    option.textContent = org;
                    orgSelect.appendChild(option);
                });

                let currentSelectedOrg = null;
                orgSelect.addEventListener("change", function () {
                    const selectedOrg = this.value;
                    if (selectedOrg === "") {
                        if (currentSelectedOrg) {
                            contributorNetworkVisual.setFilter(currentSelectedOrg, false);
                            currentSelectedOrg = null;
                        }
                    } else {
                        if (currentSelectedOrg && currentSelectedOrg !== selectedOrg) {
                            contributorNetworkVisual.setFilter(currentSelectedOrg, false);
                        }
                        contributorNetworkVisual.setFilter(selectedOrg, true);
                        currentSelectedOrg = selectedOrg;
                    }
                    updateFilterStats();
                });

                function updateFilterStats() {
                    const statsElement = document.getElementById("filter-stats");
                    if (currentSelectedOrg === null) {
                        statsElement.textContent = `Showing all ${sortedOrgs.length} organizations`;
                    } else {
                        statsElement.textContent = `Filtered to: ${currentSelectedOrg}`;
                    }
                }
                updateFilterStats();

                // Render the visualization
                contributorNetworkVisual(values);

                // Display most recent commit date across all links
                let formatDateLong = d3.utcFormat("%B %-e, %Y");
                let most_recent_commit = d3.max(values[2], d => +d.commit_sec_max);
                if (most_recent_commit) {
                    let commitDate = new Date(most_recent_commit * 1000);
                    document.getElementById("last-commit-date").innerHTML =
                        `Including commits up to ${formatDateLong(commitDate)}`;
                }
            }).catch(err => {
                console.error('Error loading data:', err);
                document.getElementById("chart-container").innerHTML =
                    '<p style="color: red; padding: 20px;">Error loading data files. Make sure CSV files exist in assets/data/.</p>';
            });
        });

        // ─── Handle resize ────────────────────────────────────────
        let resizeTimer = null;
        window.addEventListener("resize", function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (contributorNetworkVisual) {
                    let newSize = getChartDimensions();
                    container.style.height = newSize + 'px';
                    contributorNetworkVisual.width(newSize).height(newSize).resize();
                }
            }, 300);
        });
    </script>
</body>
</html>
